CSRF(Cross-Site Request Forgery) 공격은 사용자의 권한을 악용하여 원치 않는 요청을 특정 웹 애플리케이션에 전송하는 기법입니다. CSRF 공격의 핵심은 사용자가 이미 인증된 상태에서 사용자 몰래 공격자가 원하는 요청을 보내는 데 있습니다. 여기서 사용자는 공격 요청이 자신이 보낸 것인지 모른 채 자신의 권한을 통해 의도치 않은 작업을 수행하게 됩니다.

### CSRF 공격의 구성 요소 및 과정

CSRF 공격은 아래와 같은 요소로 구성됩니다.

1. **피해자**: 웹 애플리케이션에 로그인하여 인증된 상태에 있는 사용자. 예를 들어 은행 사이트에 로그인한 상태에서 CSRF 공격이 발생할 수 있습니다.
  
2. **공격자**: CSRF 공격을 통해 피해자가 인증된 상태에서 특정 요청을 전송하도록 유도하는 사람입니다.

3. **웹 애플리케이션**: CSRF 공격 대상이 되는 서버로, 피해자의 쿠키를 통해 인증된 요청을 신뢰하게 되는 시스템입니다.

CSRF 공격은 피해자가 의도치 않게 악의적인 링크나 스크립트를 통해 공격자의 요청을 전송하도록 하는 방법으로 이루어집니다. 주요 공격 방식은 다음과 같습니다.

#### 1. CSRF 공격 준비

   - 피해자는 웹 애플리케이션(예: 은행 사이트)에 로그인하여 세션 쿠키를 통해 인증된 상태가 됩니다.
   - 로그인한 상태에서 브라우저는 해당 애플리케이션에 대한 세션 쿠키를 유지합니다.
   - 세션 쿠키는 해당 애플리케이션에 요청을 보낼 때 자동으로 첨부됩니다.

#### 2. 공격자 사이트 또는 이메일을 통한 유도

   - 공격자는 피해자가 방문할 수 있는 사이트(예: 포럼, 블로그)에 악성 링크 또는 폼을 삽입합니다. 또는 피해자에게 링크가 포함된 이메일을 보낼 수도 있습니다.
   - 링크를 클릭하거나 악성 페이지를 열면 자동으로 특정 요청이 실행되도록 설계됩니다.

#### 3. CSRF 공격 실행 예시

   피해자가 악성 링크나 스크립트가 포함된 페이지를 방문할 때 다음과 같은 작업이 발생할 수 있습니다.

   ```html
   <!-- 사용자가 페이지를 로드하면 자동으로 폼이 전송되어 특정 작업을 수행하게 만드는 예제 코드 -->
   <form action="https://bank.com/transfer" method="POST">
       <input type="hidden" name="amount" value="1000">
       <input type="hidden" name="toAccount" value="attacker-account">
       <input type="submit" style="display: none;">
   </form>
   <script> document.forms[0].submit(); </script>
   ```

   - 위 코드는 `https://bank.com/transfer`로 POST 요청을 보내는 HTML 폼입니다.
   - `amount`와 `toAccount` 필드는 폼에 포함된 데이터로, 자바스크립트를 통해 폼이 자동으로 전송됩니다.
   - 브라우저는 이미 `https://bank.com` 도메인에 대한 세션 쿠키를 가지고 있으므로, 요청을 보낼 때 자동으로 세션 쿠키가 포함됩니다.
   - 은행 서버는 세션 쿠키를 확인하고 이 요청이 사용자가 보낸 것이라고 신뢰하게 됩니다. 결과적으로 피해자의 계좌에서 공격자의 계좌로 자금이 이체될 수 있습니다.

#### 4. 서버의 신뢰와 공격 성공

서버는 요청이 정상적인 사용자로부터 온 것으로 간주하고 요청을 처리합니다. 즉, 서버는 세션 쿠키가 유효하고 유효한 세션으로 로그인된 상태라면 요청을 허용하기 때문에, 이 공격이 성공하게 됩니다.

### CSRF 공격 유형

CSRF 공격은 다양한 방법으로 실행될 수 있으며, 주로 다음 두 가지 방식으로 구분됩니다.

1. **링크 기반 공격**: 피해자가 악성 링크를 클릭하면 자동으로 요청이 실행됩니다.
2. **자동 폼 제출 기반 공격**: 악성 페이지에 자바스크립트를 삽입하여 피해자가 페이지를 로드할 때 자동으로 폼이 제출되도록 합니다. 

### CSRF 공격 방지 방법

CSRF 공격을 방어하는 방법은 여러 가지가 있습니다.

1. **CSRF 토큰 사용**: CSRF 토큰은 각 요청마다 무작위로 생성된 고유한 값입니다. 서버는 요청에 포함된 CSRF 토큰을 확인하여 요청이 유효한지 검증합니다.
   
2. **SameSite 쿠키 속성 설정**: `SameSite` 속성은 쿠키가 동일한 사이트에서 온 요청에 대해서만 자동으로 전송되도록 설정하는 방법입니다.
   
3. **Referer와 Origin 헤더 검사**: 요청의 출처를 확인하여 외부 사이트에서 온 요청을 차단할 수 있습니다. 

CSRF는 사용자의 인증 상태를 악용하여 악의적인 요청을 보내는 위험한 기법이지만, 위와 같은 보안 대책을 통해 충분히 방지할 수 있습니다.
---
### HTML 코드 분석과 작동 방식

이 HTML 코드는 피해자가 페이지를 열었을 때 자동으로 특정 작업(예: 자금 이체 요청)을 수행하도록 설계된 코드입니다. 이 코드가 어떤 식으로 작동하는지 단계별로 설명하겠습니다.

#### 1. HTML 폼 구조

```html
<form action="https://mybank.com/transfer" method="POST">
    <input type="hidden" name="amount" value="1000">
    <input type="hidden" name="toAccount" value="attacker-account">
    <input type="submit" style="display: none;">
</form>
```

- `<form action="https://mybank.com/transfer" method="POST">`:
  - 이 코드는 `https://mybank.com/transfer` URL로 데이터를 전송하는 폼을 정의합니다.
  - `method="POST"` 속성은 데이터를 POST 방식으로 전송하겠다는 의미로, 일반적으로 서버에 데이터를 제출할 때 사용됩니다.

- `<input type="hidden" name="amount" value="1000">`:
  - `type="hidden"`은 폼 안에 포함되지만, 사용자가 볼 수 없는 필드를 의미합니다.
  - `name="amount"`는 서버에 전달할 데이터의 이름이 `amount`임을 나타내고, `value="1000"`은 전송할 값을 1000으로 설정합니다. 즉, 이 폼이 제출될 때 `amount`라는 이름으로 `1000`이 서버에 전송됩니다.

- `<input type="hidden" name="toAccount" value="attacker-account">`:
  - 이 필드 역시 사용자가 볼 수 없지만, `name="toAccount"`와 `value="attacker-account"` 속성을 통해 이 폼을 통해 보내는 데이터를 서버에서 `toAccount`라는 이름으로 수신하고, 그 값은 `attacker-account`로 설정됩니다. 이로 인해 서버는 자금을 `attacker-account` 계좌로 이체하려는 요청을 받게 됩니다.

- `<input type="submit" style="display: none;">`:
  - 이 코드는 폼을 제출하는 버튼 역할을 하는 `<input>` 태그입니다.
  - `style="display: none;"` 속성으로 버튼을 화면에 표시하지 않게 숨깁니다. 사용자는 이 버튼이 보이지 않기 때문에 폼이 자동으로 제출되더라도 눈치채기 어렵습니다.

#### 2. 자동 제출 스크립트

```html
<script> document.forms[0].submit(); </script>
```

- `<script>...</script>`:
  - 이 부분은 HTML 문서에 포함된 자바스크립트 코드를 나타냅니다.
  - `document.forms[0].submit();`는 자바스크립트로 `document.forms` 객체에서 첫 번째 폼(`forms[0]`)을 자동으로 제출하는 명령입니다.
  - 페이지가 로드될 때 이 코드가 실행되면서 폼이 자동으로 제출되어 `https://mybank.com/transfer`로 POST 요청이 전송됩니다.

#### 3. 자동 쿠키 전송

위 코드가 실행되면 사용자는 아무런 작업을 하지 않았음에도 불구하고 자바스크립트에 의해 폼이 자동 제출됩니다. 여기서 중요한 부분은 사용자가 로그인한 상태라면 브라우저는 자동으로 `mybank.com` 도메인에 설정된 쿠키를 전송하게 된다는 점입니다. 쿠키에는 사용자가 이전에 인증받은 세션 정보가 포함되어 있으므로 서버는 이 요청을 피해자의 요청으로 인식하게 됩니다.

이러한 과정을 통해 공격자는 피해자의 의지와 무관하게 특정 요청을 서버로 전송하는 데 성공할 수 있습니다.