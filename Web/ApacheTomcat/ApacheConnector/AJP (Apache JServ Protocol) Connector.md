## AJP (Apache JServ Protocol) Connector

**AJP (Apache JServ Protocol)** Connector는 Apache Tomcat과 외부 웹 서버(예: Apache HTTP Server) 간의 효율적인 통신을 위해 설계된 **바이너리 프로토콜**입니다. 주로 대규모 애플리케이션 환경에서 웹 서버와 애플리케이션 서버 사이의 통신을 최적화하여 성능을 개선하고, 로드 밸런싱 및 클러스터링 환경에서 높은 처리량을 제공합니다. 

AJP는 특히 **로드 밸런싱**, **프록시 통신**, 그리고 **세션 스티키니스**와 같은 기능을 지원하며, 웹 서버가 정적 콘텐츠를 처리하고 동적 콘텐츠 요청은 Tomcat으로 전달하여 처리하는 역할을 할 때 유용하게 사용됩니다. 

## 1. AJP의 정의 및 주요 목적

- **AJP (Apache JServ Protocol)**은 웹 서버가 Tomcat 애플리케이션 서버와 **프록시 통신**을 할 때 사용하는 **바이너리 프로토콜**입니다. 이는 텍스트 기반의 **HTTP** 프로토콜에 비해 **네트워크 오버헤드가 적고, 속도가 빠릅니다**.
- AJP는 주로 **Apache HTTP Server**와 같은 웹 서버가 프론트엔드에서 **정적 콘텐츠(HTML, CSS, 이미지 등)**를 처리하고, 동적 콘텐츠(JSP, 서블릿, Spring 애플리케이션 등)는 **Tomcat으로 프록시**하여 전달하는 구조에서 사용됩니다.
- 이를 통해 **웹 서버와 애플리케이션 서버 간의 통신 성능**을 최적화하고, **로드 밸런싱 및 클러스터링** 환경에서 효율적인 요청 처리를 가능하게 합니다.

## 2. AJP Connector의 동작 원리

AJP의 동작은 다음과 같은 과정으로 이루어집니다:

1. **클라이언트 요청 수신**: 클라이언트가 HTTP 요청을 Apache HTTP Server와 같은 웹 서버에 전송합니다.
2. **웹 서버에서 요청 처리**: Apache HTTP Server는 정적 콘텐츠를 직접 처리하거나, 동적 콘텐츠 요청을 **AJP Connector**를 통해 Tomcat에 전달합니다.
3. **AJP 통신**: 웹 서버와 Tomcat 간의 통신이 **AJP 프로토콜**을 통해 이루어지며, 웹 서버는 HTTP 요청을 AJP의 바이너리 형식으로 변환하여 **Tomcat AJP Connector**에 전달합니다.
4. **Tomcat에서 요청 처리**: Tomcat의 AJP Connector는 요청을 서블릿 컨테이너로 전달하고, 적절한 서블릿 또는 애플리케이션이 요청을 처리합니다.
5. **응답 반환**: Tomcat에서 생성된 응답을 다시 AJP Connector를 통해 Apache 웹 서버에 전달합니다.
6. **클라이언트 응답 반환**: Apache 웹 서버는 최종적으로 처리된 결과를 클라이언트에게 응답합니다.

이 과정에서 AJP는 HTTP보다 더 **빠른 데이터 처리**를 제공하며, 네트워크 오버헤드를 줄여 **통신 성능**을 향상시킵니다.

## 3. AJP Connector의 구성 요소 및 설정

AJP는 **Tomcat의 `server.xml`** 파일에서 **<Connector>** 요소를 통해 설정됩니다. AJP Connector는 다음과 같은 주요 속성들을 사용하여 설정할 수 있습니다.

### 3.1 주요 설정 속성

```xml
<Connector protocol="AJP/1.3" 
           port="8009" 
           redirectPort="8443" 
           maxThreads="200" 
           connectionTimeout="20000" 
           address="127.0.0.1" 
           secret="yourSecret" />
```

- **`protocol`**: AJP 프로토콜의 버전(일반적으로 `AJP/1.3` 사용).
- **`port`**: AJP 커넥터가 사용할 포트 번호 (기본값: `8009`).
- **`redirectPort`**: HTTPS 요청으로 리디렉션할 포트 번호 (일반적으로 `8443`).
- **`maxThreads`**: AJP 커넥터가 동시에 처리할 수 있는 최대 스레드 수.
- **`connectionTimeout`**: AJP 커넥터의 연결 타임아웃 시간(밀리초 단위).
- **`address`**: AJP 커넥터가 바인딩할 IP 주소. 이를 통해 **로컬 네트워크** 또는 특정 IP에서만 AJP 포트 접근을 허용할 수 있습니다.
- **`secret`**: AJP 커넥터의 보안을 강화하기 위해 **비밀 키**를 설정하여, 웹 서버와 Tomcat 간의 인증된 통신만 허용합니다.

### 3.2 Apache HTTP Server와의 연계 설정

Apache HTTP Server와 AJP를 연동하기 위해서는 **`mod_proxy_ajp`** 모듈이나 **`mod_jk`** 모듈을 사용하여 설정할 수 있습니다.

#### `mod_proxy_ajp` 설정 예시

```apache
<VirtualHost *:80>
    ProxyPass / ajp://localhost:8009/
    ProxyPassReverse / ajp://localhost:8009/
</VirtualHost>
```

- **`ProxyPass`**: Apache가 클라이언트로부터 받은 요청을 Tomcat의 AJP 포트로 전달합니다.
- **`ProxyPassReverse`**: Tomcat에서 반환된 응답을 클라이언트에게 전달하도록 설정합니다.

#### `mod_jk` 설정 예시

**`workers.properties`** 파일에 설정을 정의하여 Tomcat과 연계할 수 있습니다.

```properties
worker.list=ajp13
worker.ajp13.type=ajp13
worker.ajp13.host=localhost
worker.ajp13.port=8009
```

- `worker.list`: 사용할 worker 이름을 정의합니다.
- `worker.ajp13.type`: 사용할 프로토콜 타입(`ajp13`)을 지정합니다.
- `worker.ajp13.host`: Tomcat의 AJP 커넥터가 실행되는 호스트 이름을 지정합니다.
- `worker.ajp13.port`: AJP 커넥터가 사용하는 포트 번호(일반적으로 8009).

## 4. AJP의 주요 기능 및 특징

### 4.1 바이너리 프로토콜을 통한 고속 통신

- **AJP는 바이너리 형식**으로 데이터를 전송하기 때문에, 텍스트 기반의 **HTTP보다 빠른 데이터 처리**가 가능합니다.
- 특히 대규모 트래픽 환경에서 네트워크 오버헤드를 줄이고, **헤더 압축**을 통해 **대역폭 사용을 최적화**할 수 있습니다.

### 4.2 세션 스티키니스(Session Stickiness)

- AJP는 **로드 밸런싱 환경에서 세션 스티키니스** 기능을 지원합니다. 이를 통해 클라이언트의 세션이 **초기 연결된 Tomcat 인스턴스**에 계속 유지되도록 보장합니다.
- AJP는 **JSESSIONID** 쿠키를 분석하여 **같은 사용자가 항상 동일한 서버에서** 세션을 유지하도록 하여 **세션 일관성**을 보장합니다.

### 4.3 보안 강화

- **비밀 키(secret)**를 설정하여, Tomcat과 Apache HTTP Server 간의 인증된 요청만을 처리할 수 있습니다. 외부의 비인가된 요청이 AJP 포트에 접근하는 것을 방지할 수 있습니다.
- **Ghostcat 취약점**(CVE-2020-1938)은 AJP 포트를 통한 외부 접근으로 **Tomcat 서버의 파일 시스템 접근**이 가능해지는 취약점입니다. 이를 방지하기 위해 **방화벽 설정** 및 **포트 접근 제한**을 필수적으로 설정해야 합니다.

### 4.4 클러스터링 및 로드 밸런싱 지원

- AJP는 **로드 밸런싱** 및 **클러스터링 환경**에서 유용하게 사용됩니다. 여러 Tomcat 인스턴스 간의 세션 복제와 장애 조치(failover)를 수행할 수 있습니다.
- 이를 통해 한 서버가 장애가 발생해도 다른 서버에서 세션을 이어받아 **고가용성을 보장**할 수 있습니다.

## 5. AJP와 HTTP의 비교

| **특징**                  | **AJP**                            | **HTTP**                           |
|---------------------------|------------------------------------|------------------------------------|
| **프로토콜 형식**         | 바이너리                            | 텍스트                             |
| **속도**                  | 빠름                                | 느림                               |
| **주 사용 사례**          | 프록시 서버와 애플리케이션 서버 간 통신 | 클라이언트와 웹 서버 간 통신         |
| **보안**                  | 비밀 키와 방화벽 설정을 통한 접근 보호  | SSL/TLS로 암호화 가능               |
| **세션 스티키니스**       | 지원                                | 기본 HTTP에서는 지원하지 않음       |
| **네트워크 오버헤드**     | 적음                                | 많음                               |

이와 같은 AJP의 특징을 활용

하면, Tomcat과 웹 서버 간의 **고성능 통신 환경**을 구성할 수 있으며, 로드 밸런싱 및 세션 일관성을 유지하면서 애플리케이션 서버의 **확장성과 가용성**을 높일 수 있습니다.