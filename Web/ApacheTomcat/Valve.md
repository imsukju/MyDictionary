## Apache Tomcat의 Valve(밸브)

**Apache Tomcat**에서 **Valve(밸브)**는 요청(Request)과 응답(Response)을 처리하는 **파이프라인(pipeline)**의 중요한 구성 요소로, 톰캣 내부에서 특정 HTTP 요청과 관련된 작업을 처리하거나 요청을 제어하는 역할을 수행합니다. 밸브는 톰캣의 **컨테이너(Container)** 레벨에서 설정되며, 톰캣의 특정 요청 처리 단계에서만 작동합니다.

밸브는 **인증, 접근 제어, 로깅, 요청/응답 조작** 등의 다양한 기능을 수행할 수 있으며, 톰캣의 **Engine**, **Host**, 또는 **Context** 레벨에 적용할 수 있습니다. 이러한 유연성 덕분에 톰캣 서버의 동작을 세부적으로 조정하고, 필요한 경우 사용자 정의 밸브를 통해 추가적인 기능을 구현할 수도 있습니다.

## 1. Valve의 개념 및 특징

### 1.1 Valve의 개념

- 밸브는 톰캣의 **Pipeline 구조**에서 특정 요청 처리 작업을 수행하는 **확장 포인트**입니다.
- **서블릿 필터**와 비슷한 기능을 제공하지만, **톰캣 컨테이너 수준**에서 동작하며, 서블릿이 실행되기 전에 요청을 처리합니다.
- 필터는 **애플리케이션** 수준에서 동작하는 반면, 밸브는 **톰캣 컨테이너**(Engine, Host, Context)와 같은 더 넓은 범위에서 동작하여, 서블릿 컨텍스트에 종속적이지 않고 **더 높은 수준의 요청 제어**를 할 수 있습니다.

### 1.2 Valve의 특징

1. **요청 전처리 및 후처리**
   - 밸브는 **요청 처리 단계**에서 전처리(pre-processing)와 후처리(post-processing)를 수행할 수 있습니다. 이를 통해 특정 요청을 검사하거나 수정한 후 서블릿 컨테이너에 전달하고, 응답을 처리하거나 변경한 후 클라이언트에 반환할 수 있습니다.

2. **파이프라인(Pipeline)과 밸브 체인(Chain)**
   - 톰캣의 **Pipeline 구조**는 여러 밸브를 **체인(chain)** 형태로 연결하여 처리하며, 각 밸브는 다음 밸브로 요청을 전달합니다.
   - 이 구조를 통해 요청이 들어오면 밸브 체인을 따라 순차적으로 밸브가 실행되고, 마지막에 서블릿이 호출됩니다.

3. **단일 확장 포인트**
   - 밸브는 서블릿 컨테이너 내부의 특정 확장 지점에서 동작하여, 개발자가 직접 **커스텀 밸브**를 작성하여 톰캣의 요청 처리 로직을 확장할 수 있습니다.

4. **톰캣의 여러 컨테이너에 설정 가능**
   - 밸브는 **Engine**, **Host**, **Context** 레벨에 설정할 수 있으며, 각각의 컨테이너에 따라 적용 범위가 다릅니다.

   - **Engine**: 전체 톰캣 인스턴스에 대해 모든 요청에 적용됩니다.
   - **Host**: 특정 호스트의 요청에만 적용됩니다.
   - **Context**: 특정 웹 애플리케이션(Context)의 요청에만 적용됩니다.

5. **밸브 클래스 구현**
   - 밸브는 톰캣의 `org.apache.catalina.Valve` 인터페이스를 구현하여 정의됩니다.
   - 밸브의 핵심 메서드는 `invoke()` 메서드로, 요청이 들어올 때 호출되어 요청을 처리한 후 다음 밸브로 요청을 전달하거나, 요청 처리를 중지하고 바로 응답을 생성할 수 있습니다.

## 2. Tomcat의 대표적인 밸브 종류

톰캣은 몇 가지 기본적으로 제공되는 밸브를 통해 자주 사용되는 요청 처리 작업을 쉽게 설정할 수 있습니다. 주요 밸브의 종류와 사용 방법은 다음과 같습니다.

### 2.1 AccessLogValve

- **AccessLogValve**는 **요청과 응답에 대한 정보를 로깅**하는 밸브입니다. 주로 웹 서버의 **접속 로그**를 기록하는 데 사용됩니다.
- 로그 포맷을 커스터마이징하여, **클라이언트의 IP 주소, 요청 메서드, 응답 코드, 응답 시간** 등의 다양한 정보를 기록할 수 있습니다.

  **설정 예시**:
  ```xml
  <Host name="localhost" appBase="webapps" unpackWARs="true" autoDeploy="true">
      <Valve className="org.apache.catalina.valves.AccessLogValve"
             directory="logs"
             prefix="localhost_access_log"
             suffix=".txt"
             pattern="%h %l %u %t \"%r\" %s %b" />
  </Host>
  ```

  - `directory`: 로그 파일이 저장될 디렉토리.
  - `prefix`: 로그 파일 이름의 접두어.
  - `suffix`: 로그 파일 이름의 접미사.
  - `pattern`: 기록할 로그의 형식을 지정 (예: `%h`는 클라이언트의 IP, `%r`은 요청 라인).

### 2.2 RemoteIpValve

- **RemoteIpValve**는 **프록시 서버나 로드 밸런서** 뒤에서 톰캣이 동작할 때, **실제 클라이언트의 IP 주소를 추출**하여 설정하는 밸브입니다.
- 기본적으로 프록시나 로드 밸런서 뒤에 있을 때는 톰캣이 직접 클라이언트의 IP를 알 수 없지만, **X-Forwarded-For**와 같은 헤더를 기반으로 **실제 클라이언트의 IP**를 확인하고 설정할 수 있습니다.

  **설정 예시**:
  ```xml
  <Valve className="org.apache.catalina.valves.RemoteIpValve"
         remoteIpHeader="X-Forwarded-For"
         protocolHeader="X-Forwarded-Proto" />
  ```

  - `remoteIpHeader`: 클라이언트 IP를 나타내는 헤더.
  - `protocolHeader`: HTTP 프로토콜(예: `http` 또는 `https`)을 나타내는 헤더.

### 2.3 SingleSignOnValve

- **SingleSignOnValve**는 톰캣 내의 **여러 애플리케이션 사이에서 단일 로그인(Single Sign-On, SSO)** 기능을 제공합니다.
- 한 번의 로그인으로 동일한 호스트 내에 있는 여러 애플리케이션에 접근할 수 있도록 지원하며, SSO 쿠키를 사용하여 세션을 관리합니다.

  **설정 예시**:
  ```xml
  <Valve className="org.apache.catalina.authenticator.SingleSignOn" />
  ```

### 2.4 RewriteValve

- **RewriteValve**는 Apache HTTP Server의 `mod_rewrite`와 유사하게 **URL 재작성(Rewrite)**을 지원하는 밸브입니다.
- 특정 규칙을 기반으로 **URL을 변환**하여, 요청 경로를 변경하거나, 특정 요청을 다른 URL로 리디렉션할 수 있습니다.

  **설정 예시**:
  ```xml
  <Valve className="org.apache.catalina.valves.rewrite.RewriteValve" />
  ```

  - `RewriteCond`, `RewriteRule`을 사용하여 URL 재작성 규칙을 정의할 수 있습니다.

### 2.5 ErrorReportValve

- **ErrorReportValve**는 요청 처리 중 **오류가 발생했을 때 사용자 지정 오류 페이지를 제공**하는 밸브입니다.
- 예를 들어, **404 오류**나 **500 오류**와 같은 특정 오류가 발생하면 사용자에게 보여줄 페이지를 정의할 수 있습니다.

  **설정 예시**:
  ```xml
  <Valve className="org.apache.catalina.valves.ErrorReportValve"
         showReport="false"
         showServerInfo="false" />
  ```

  - `showReport`: 오류 상세 내용을 표시할지 여부.
  - `showServerInfo`: 서버 정보(예: 톰캣 버전)를 표시할지 여부.

## 3. Valve와 Filter의 차이점

| **특징**               | **Valve**                                                | **Filter**                                             |
|------------------------|----------------------------------------------------------|--------------------------------------------------------|
| **적용 레벨**          | Engine, Host, Context와 같은 톰캣 컨테이너 레벨          | 웹 애플리케이션 레벨                                    |
| **동작 위치**          | 서블릿 컨테이너 내부의 요청 파이프라인에서 특정 단계에서 동작 | 서블릿이 호출되기 전후에 동작                           |
| **종속성**             | 톰캣 컨테이너와 밀접하게 연관됨                          | 특정 서블릿 컨텍스트와 연관됨                           |
| **사용 용도**          | 요청 전처리, 후처리, 로깅, 인증, 접근 제어 등              | 서블릿 요청 및 응답의 조작, 인증 및 요청 변경           |

## 4. Valve 사용 시 고려 사항

1. **성능 영향

**: 밸브는 요청 처리 파이프라인의 중간에 위치하므로, 복잡한 로직이 포함된 경우 응답 시간이 지연될 수 있습니다.
2. **보안 설정**: RemoteIpValve와 같은 밸브는 잘못된 설정 시 보안 취약점을 야기할 수 있으므로, 신뢰할 수 있는 프록시만 허용하도록 설정해야 합니다.
3. **적절한 적용 범위 설정**: 밸브는 적용되는 컨테이너의 범위가 넓기 때문에, 필요한 요청 범위에만 적용되도록 설정해야 합니다.

밸브는 톰캣의 요청 처리 구조에서 중요한 역할을 수행하며, 이를 통해 서버의 로깅, 인증, 보안 설정을 효과적으로 관리할 수 있습니다.